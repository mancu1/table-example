# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
- [–û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è](#–æ–±—â–∞—è-–∫–æ–Ω—Ü–µ–ø—Ü–∏—è)
- [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã](#–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã-—Å–∏—Å—Ç–µ–º—ã)
- [–ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö](#–º–æ–¥–µ–ª—å-–¥–∞–Ω–Ω—ã—Ö)
- [–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö](#—Ö—Ä–∞–Ω–µ–Ω–∏–µ-–¥–∞–Ω–Ω—ã—Ö)
- [–°–∏—Å—Ç–µ–º–∞ —è–∫–æ—Ä–µ–π (Anchors)](#—Å–∏—Å—Ç–µ–º–∞-—è–∫–æ—Ä–µ–π-anchors)
- [–ì—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π](#–≥—Ä–∞—Ñ-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
- [–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –æ–ø–µ—Ä–∞—Ü–∏–π](#–∂–∏–∑–Ω–µ–Ω–Ω—ã–π-—Ü–∏–∫–ª-–æ–ø–µ—Ä–∞—Ü–∏–π)
- [–ê–ª–≥–æ—Ä–∏—Ç–º—ã –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å](#–∞–ª–≥–æ—Ä–∏—Ç–º—ã-–∏-—Å–ª–æ–∂–Ω–æ—Å—Ç—å)

---

## –û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞

–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—á–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ—á–µ–Ω—å –±–æ–ª—å—à–∏–º–∏ –ª–∏—Å—Ç–∞–º–∏ (–¥–æ 1 000 000 √ó 16 000 —è—á–µ–µ–∫), –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º:
- –ù–µ —Ç—Ä–∞—Ç–∏—Ç—å –ø–∞–º—è—Ç—å –Ω–∞ –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏
- –ë—ã—Å—Ç—Ä–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å —Å—Ç—Ä–æ–∫–∏ –∏ —Å—Ç–æ–ª–±—Ü—ã
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ñ–æ—Ä–º—É–ª—ã –ø—Ä–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–∏–≤—à–∏–µ—Å—è —Ñ–æ—Ä–º—É–ª—ã

### –†–µ—à–µ–Ω–∏–µ

**–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è:** —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ **–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–æ–∑–∏—Ü–∏–π** (—á—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) –∏ **—Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤** (—á—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏).

```
–ü–æ–∑–∏—Ü–∏–∏ (1...N)  ‚Üê‚Üí  –°—Ç–∞–±–∏–ª—å–Ω—ã–µ ID (id0, id1, ...)
     ‚Üì                        ‚Üì
–ß—Ç–æ –≤–∏–¥–∏—Ç                –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç
–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å             —Å–∏—Å—Ç–µ–º–∞
```

–ü—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ/—É–¥–∞–ª–µ–Ω–∏–∏ –º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ **–º–∞–ø–ø–∏–Ω–≥–∏ –ø–æ–∑–∏—Ü–∏—è‚ÜîID**, —Å–∞–º–∏ —è—á–µ–π–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏.

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. **CellStore** - —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —è—á–µ–µ–∫

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–ª—å–∫–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —è—á–µ–π–∫–∏ –≤ —Ä–∞–∑—Ä–µ–∂–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```typescript
class CellStore {
  private cells: Map<string, Cell>
  //              ‚Üë           ‚Üë
  //         "rowId:colId"  —è—á–µ–π–∫–∞
}
```

**–ö–ª—é—á:** —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ `"id5:id12"` - –∫–æ–º–±–∏–Ω–∞—Ü–∏—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö ID —Å—Ç—Ä–æ–∫–∏ –∏ —Å—Ç–æ–ª–±—Ü–∞.

**–ó–Ω–∞—á–µ–Ω–∏–µ:** —è—á–µ–π–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –±—ã—Ç—å:
- **Value** - –ø—Ä–æ—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—á–∏—Å–ª–æ)
- **Formula** - —Ñ–æ—Ä–º—É–ª–∞ —Å AST –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º

**–ü—Ä–∏–º–µ—Ä:**
```javascript
{
  "id0:id0": { kind: "value", value: 10 },
  "id0:id1": { kind: "formula", ast: {...}, cached: 10 }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- O(1) –¥–æ—Å—Ç—É–ø –∫ —è—á–µ–π–∫–µ –ø–æ ID
- –ü–∞–º—è—Ç—å —Ä–∞—Å—Ç–µ—Ç —Ç–æ–ª—å–∫–æ –æ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —è—á–µ–µ–∫
- –õ–µ–≥–∫–æ –∏—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —è—á–µ–π–∫–∞–º

### 2. **AxisIndex** - –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç **–ø–æ–∑–∏—Ü–∏–∏** (—á—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) –≤ **ID** (—á—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è) –∏ –æ–±—Ä–∞—Ç–Ω–æ.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```typescript
interface Segment {
  startPos: number;   // –° –∫–∞–∫–æ–π –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è
  ids: AxisId[];      // –ú–∞—Å—Å–∏–≤ ID –¥–ª—è —ç—Ç–∏—Ö –ø–æ–∑–∏—Ü–∏–π
}

class AxisIndex {
  private segments: Segment[] = [];
  private nextId = 0;
}
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

```
–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: new AxisIndex(100)

segments = [
  {
    startPos: 1,
    ids: ["id0", "id1", "id2", ..., "id99"]
  }
]

–ü–æ–∑–∏—Ü–∏—è 1 ‚Üí id0
–ü–æ–∑–∏—Ü–∏—è 2 ‚Üí id1
...
–ü–æ–∑–∏—Ü–∏—è 100 ‚Üí id99
```

**–ü—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ:**
```typescript
// –í—Å—Ç–∞–≤–∏—Ç—å 2 —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –ø–æ–∑–∏—Ü–∏—é 50
rows.insert(50, 2);

// –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–æ–≤—ã–µ ID: id100, id101
// –í—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ –º–∞—Å—Å–∏–≤ –Ω–∞ –Ω—É–∂–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
segments[0].ids.splice(49, 0, "id100", "id101");

// –¢–µ–ø–µ—Ä—å:
// –ü–æ–∑–∏—Ü–∏—è 50 ‚Üí id100 (–Ω–æ–≤–∞—è)
// –ü–æ–∑–∏—Ü–∏—è 51 ‚Üí id101 (–Ω–æ–≤–∞—è)
// –ü–æ–∑–∏—Ü–∏—è 52 ‚Üí id49 (–±—ã–ª–∞ –ø–æ–∑–∏—Ü–∏—è 50)
```

**–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:**
```typescript
// –£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 50-51
rows.remove({ from: 50, to: 51 });

// –£–¥–∞–ª—è—é—Ç—Å—è –∏–∑ –º–∞—Å—Å–∏–≤–∞
segments[0].ids.splice(49, 2);

// ID —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –Ω–æ –±–æ–ª—å—à–µ –Ω–µ –º–∞–ø–ø—è—Ç—Å—è –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –í—Å—Ç–∞–≤–∫–∞/—É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —è—á–µ–π–∫–∏
- O(log S) –Ω–∞ –ø–æ–∏—Å–∫ (–≥–¥–µ S - —á–∏—Å–ª–æ —Å–µ–≥–º–µ–Ω—Ç–æ–≤, –æ–±—ã—á–Ω–æ 1)
- –°—Ç–∞–±–∏–ª—å–Ω—ã–µ ID –Ω–µ –º–µ–Ω—è—é—Ç—Å—è

### 3. **DepGraph** - –≥—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç, –∫–∞–∫–∏–µ —Ñ–æ—Ä–º—É–ª—ã –æ—Ç –∫–∞–∫–∏—Ö —è—á–µ–µ–∫ –∑–∞–≤–∏—Å—è—Ç.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```typescript
class DepGraph {
  // from -> set of to (–∫—Ç–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç from)
  private outgoing: Map<string, Set<string>>;
  
  // to -> set of from (–æ—Ç –∫–æ–≥–æ –∑–∞–≤–∏—Å–∏—Ç to)
  private incoming: Map<string, Set<string>>;
}
```

**–ü—Ä–∏–º–µ—Ä:**
```
A1: 10
B1: =A1
C1: =SUM(A1:B1)

–ì—Ä–∞—Ñ:
outgoing = {
  "id0:id0": Set["id0:id1", "id0:id2"],  // A1 ‚Üí B1, C1
  "id0:id1": Set["id0:id2"]              // B1 ‚Üí C1
}

incoming = {
  "id0:id1": Set["id0:id0"],             // B1 ‚Üê A1
  "id0:id2": Set["id0:id0", "id0:id1"]   // C1 ‚Üê A1, B1
}
```

**–ê–ª–≥–æ—Ä–∏—Ç–º –ø–µ—Ä–µ—Å—á–µ—Ç–∞:**
1. –ò–∑–º–µ–Ω–∏–ª–∞—Å—å —è—á–µ–π–∫–∞ A1
2. –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º—ã—Ö: `affectedFrom({"id0:id0"})` ‚Üí `{"id0:id0", "id0:id1", "id0:id2"}`
3. –¢–æ–ø–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º: A1 ‚Üí B1 ‚Üí C1
4. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤ —ç—Ç–æ–º –ø–æ—Ä—è–¥–∫–µ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–æ—Ä–º—É–ª—ã
- O(affected + edges) - –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —á–∏—Å–ª—É —Ä–µ–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–≤—à–∏—Ö—Å—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è —Ü–∏–∫–ª–æ–≤

### 4. **RangeWatchers** - –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç, –∫–∞–∫–∏–µ —Ñ–æ—Ä–º—É–ª—ã –Ω–∞–±–ª—é–¥–∞—é—Ç –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏.

**–ü—Ä–æ–±–ª–µ–º–∞:** `=SUM(A1:C3)` –¥–æ–ª–∂–Ω–∞ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å—Å—è, –µ—Å–ª–∏:
- –ò–∑–º–µ–Ω–∏–ª–∞—Å—å –ª—é–±–∞—è —è—á–µ–π–∫–∞ –≤–Ω—É—Ç—Ä–∏ A1:C3
- –ü–æ—è–≤–∏–ª–∞—Å—å –Ω–æ–≤–∞—è —è—á–µ–π–∫–∞ –≤–Ω—É—Ç—Ä–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```typescript
class RangeWatchers {
  // –Ø—á–µ–π–∫–∞ ‚Üí —Ñ–æ—Ä–º—É–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—ë –Ω–∞–±–ª—é–¥–∞—é—Ç
  private watchers: Map<string, Set<string>>;
  
  // –§–æ—Ä–º—É–ª–∞ ‚Üí –¥–∏–∞–ø–∞–∑–æ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω–∞ –Ω–∞–±–ª—é–¥–∞–µ—Ç
  private formulaRanges: Map<string, RangeRef[]>;
}
```

**–ü—Ä–∏–º–µ—Ä:**
```
A5: =SUM(A1:C3)

–ü—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ SUM:
1. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω –≤ —Å–ø–∏—Å–æ–∫ —è—á–µ–µ–∫: A1, B1, C1, A2, B2, C2, A3, B3, C3
2. –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ DepGraph: A1‚ÜíA5, B1‚ÜíA5, ..., C3‚ÜíA5
3. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ watchers:
   watchers["id0:id0"] = Set["id4:id0"]  // A1 ‚Üí A5
   watchers["id0:id1"] = Set["id4:id0"]  // B1 ‚Üí A5
   ...
```

**–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ B2:**
1. –°–º–æ—Ç—Ä–∏–º `watchers.get("id1:id1")` ‚Üí Set["id4:id0"]
2. –î–æ–±–∞–≤–ª—è–µ–º A5 –≤ —Å–ø–∏—Å–æ–∫ –Ω–∞ –ø–µ—Ä–µ—Å—á–µ—Ç

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–∞—Ö
- –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ —Å –Ω–æ–≤—ã–º–∏ —è—á–µ–π–∫–∞–º–∏

---

## –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

### –ò–µ—Ä–∞—Ä—Ö–∏—è

```
Table
  ‚îî‚îÄ‚îÄ Sheet
      ‚îú‚îÄ‚îÄ CellStore (cells)
      ‚îú‚îÄ‚îÄ AxisIndex (rows)
      ‚îú‚îÄ‚îÄ AxisIndex (cols)
      ‚îú‚îÄ‚îÄ DepGraph (deps)
      ‚îî‚îÄ‚îÄ RangeWatchers (ranges)
```

### –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

#### Address - —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
```typescript
type Address = {
  row: RowId;  // "id5"
  col: ColId;  // "id12"
}
```
**–≠—Ç–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å**, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–∞—Ö/—É–¥–∞–ª–µ–Ω–∏—è—Ö.

#### Position - –ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–∑–∏—Ü–∏—è
```typescript
type Position = {
  r: number;  // 1-based: 1, 2, 3, ...
  c: number;  // 1-based: 1, 2, 3, ...
}
```
**–≠—Ç–æ —Ç–æ, —á—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**, –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–∞—Ö/—É–¥–∞–ª–µ–Ω–∏—è—Ö.

#### Cell - —è—á–µ–π–∫–∞
```typescript
type Cell = 
  | { kind: 'value'; value: Scalar }
  | { kind: 'formula'; ast: Formula; cached?: Scalar }
```

#### Formula - —Ñ–æ—Ä–º—É–ª–∞
```typescript
type Formula =
  | { t: 'Ref'; ref: Anchor }          // =A1
  | { t: 'Sum'; range: RangeRef }      // =SUM(A1:C3)
```

#### Anchor - —è–∫–æ—Ä—å —Å—Å—ã–ª–∫–∏
```typescript
type Anchor = {
  base: Address;           // –ì–¥–µ —Å—Ç–æ–∏—Ç —Ñ–æ—Ä–º—É–ª–∞
  rowMode: 'rel' | 'abs';  // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è/–∞–±—Å–æ–ª—é—Ç–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
  colMode: 'rel' | 'abs';  // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π/–∞–±—Å–æ–ª—é—Ç–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü
  dRow: number;            // –°–º–µ—â–µ–Ω–∏–µ –ø–æ —Å—Ç—Ä–æ–∫–µ
  dCol: number;            // –°–º–µ—â–µ–Ω–∏–µ –ø–æ —Å—Ç–æ–ª–±—Ü—É
}
```

**–ö–ª—é—á–µ–≤–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è:** —Å—Å—ã–ª–∫–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –∞ —Ö—Ä–∞–Ω–∏—Ç **—Å–º–µ—â–µ–Ω–∏–µ –æ—Ç –±–∞–∑—ã** –∏ **—Ä–µ–∂–∏–º**.

---

## –°–∏—Å—Ç–µ–º–∞ —è–∫–æ—Ä–µ–π (Anchors)

### –ó–∞—á–µ–º –Ω—É–∂–Ω—ã —è–∫–æ—Ä—è?

**–ü—Ä–æ–±–ª–µ–º–∞:** –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ —Å—Ç—Ä–æ–∫–∏ —Ñ–æ—Ä–º—É–ª—ã –¥–æ–ª–∂–Ω—ã "—Å–¥–≤–∏–≥–∞—Ç—å—Å—è" –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

```
–î–û:
A1: 10
A2: =A1  ‚Üê —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ A1

–í—Å—Ç–∞–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –ø–æ–∑–∏—Ü–∏—é 2

–ü–û–°–õ–ï:
A1: 10
A2: (–ø—É—Å—Ç–æ)
A3: =A1  ‚Üê –¥–æ–ª–∂–Ω–∞ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ A1!
```

**–ù–∞–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç):**
```typescript
// –•—Ä–∞–Ω–∏—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
formula = { target: { row: 1, col: 1 } }

// –ü—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –Ω—É–∂–Ω–æ:
// 1. –ù–∞–π—Ç–∏ –í–°–ï —Ñ–æ—Ä–º—É–ª—ã
// 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ —Ü–µ–ª—å –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏
// 3. –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é
// = O(N) –Ω–∞ –∫–∞–∂–¥—É—é –≤—Å—Ç–∞–≤–∫—É, –≥–¥–µ N - —á–∏—Å–ª–æ —Ñ–æ—Ä–º—É–ª
```

**–†–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —è–∫–æ—Ä—è:**
```typescript
// –•—Ä–∞–Ω–∏—Ç—å –°–ú–ï–©–ï–ù–ò–ï –æ—Ç –±–∞–∑—ã
anchor = {
  base: { row: "id1", col: "id0" },  // –ì–¥–µ —Å—Ç–æ–∏—Ç —Ñ–æ—Ä–º—É–ª–∞ (A2)
  rowMode: 'rel',                     // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è
  colMode: 'rel',
  dRow: -1,                           // –ù–∞ 1 —Å—Ç—Ä–æ–∫—É –≤—ã—à–µ
  dCol: 0                             // –¢–æ—Ç –∂–µ —Å—Ç–æ–ª–±–µ—Ü
}
```

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —è–∫–æ—Ä—å

#### –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —è–∫–æ—Ä—è –≤ –∞–¥—Ä–µ—Å
```typescript
function anchorToAddress(anchor: Anchor): Address {
  // 1. –£–∑–Ω–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –±–∞–∑—ã
  const baseRowPos = rowAxis.idToPos(anchor.base.row);  // 2
  const baseColPos = colAxis.idToPos(anchor.base.col);  // 1
  
  // 2. –ü—Ä–∏–±–∞–≤–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ
  const targetRowPos = baseRowPos + anchor.dRow;  // 2 + (-1) = 1
  const targetColPos = baseColPos + anchor.dCol;  // 1 + 0 = 1
  
  // 3. –ü–æ–ª—É—á–∞–µ–º ID —Ü–µ–ª–µ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
  const targetRowId = rowAxis.posToId(targetRowPos);  // "id0"
  const targetColId = colAxis.posToId(targetColPos);  // "id0"
  
  return { row: targetRowId, col: targetColId };  // A1
}
```

**–ú–∞–≥–∏—è:** –¥–∞–∂–µ –µ—Å–ª–∏ –±–∞–∑–∞ (—Ñ–æ—Ä–º—É–ª–∞) —Å–¥–≤–∏–Ω—É–ª–∞—Å—å –Ω–∞ –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é, —Å–º–µ—â–µ–Ω–∏–µ `dRow=-1` –≤—Å—ë —Ä–∞–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —è—á–µ–π–∫—É!

### –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è —è–∫–æ—Ä—è –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ

```typescript
function transformAnchor(anchor: Anchor, splice: Splice): Anchor {
  // Splice: { axis: 'row', atPos: 2, ins: 1, del: 0 }
  // –í—Å—Ç–∞–≤–∏—Ç—å 1 —Å—Ç—Ä–æ–∫—É –Ω–∞ –ø–æ–∑–∏—Ü–∏—é 2
  
  const basePos = rowAxis.idToPos(anchor.base.row);  // 2 (—Ñ–æ—Ä–º—É–ª–∞ –≤ A2)
  const targetPos = basePos + anchor.dRow;           // 2 + (-1) = 1 (—Ü–µ–ª—å A1)
  
  if (anchor.rowMode === 'rel') {
    // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
    
    // –ë–∞–∑–∞ —Å–¥–≤–∏–≥–∞–µ—Ç—Å—è?
    if (basePos >= splice.atPos) {  // 2 >= 2 ‚Üí –¥–∞
      newBasePos = basePos + splice.ins;  // 2 + 1 = 3
    }
    
    // –¶–µ–ª—å —Å–¥–≤–∏–≥–∞–µ—Ç—Å—è?
    if (targetPos >= splice.atPos) {  // 1 >= 2 ‚Üí –Ω–µ—Ç
      newTargetPos = targetPos;  // –æ—Å—Ç–∞–µ—Ç—Å—è 1
    }
    
    // –ù–æ–≤–æ–µ —Å–º–µ—â–µ–Ω–∏–µ
    newDRow = newTargetPos - newBasePos;  // 1 - 3 = -2
    
    return {
      ...anchor,
      base: { row: "id2", col: "id0" },  // –Ω–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è –±–∞–∑—ã
      dRow: -2                            // –Ω–æ–≤–æ–µ —Å–º–µ—â–µ–Ω–∏–µ
    };
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–î–û:
A2: =A1  (base=id1, dRow=-1)

–í—Å—Ç–∞–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏ 2

–ü–û–°–õ–ï:
A3: =A1  (base=id2, dRow=-2)
         ‚Üë         ‚Üë
    –±–∞–∑–∞ —Å–¥–≤–∏–Ω—É–ª–∞—Å—å, —Å–º–µ—â–µ–Ω–∏–µ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–ª–æ—Å—å
```

### –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ vs –ê–±—Å–æ–ª—é—Ç–Ω—ã–µ

#### –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞: `=A1`
```typescript
anchor = {
  rowMode: 'rel',
  colMode: 'rel',
  dRow: -1,
  dCol: 0
}
```
**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:** –∏ –±–∞–∑–∞, –∏ —Ü–µ–ª—å —Å–¥–≤–∏–≥–∞—é—Ç—Å—è –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ ‚Üí —Å–º–µ—â–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è, —á—Ç–æ–±—ã –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ —Ç—É –∂–µ —è—á–µ–π–∫—É.

#### –ê–±—Å–æ–ª—é—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞: `=$A$1`
```typescript
anchor = {
  rowMode: 'abs',
  colMode: 'abs',
  dRow: -1,
  dCol: 0
}
```
**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:** –±–∞–∑–∞ —Å–¥–≤–∏–≥–∞–µ—Ç—Å—è, –Ω–æ —Ü–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ ‚Üí —Å–º–µ—â–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–∞–∫, —á—Ç–æ–±—ã —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é 1.

#### –°–º–µ—à–∞–Ω–Ω–∞—è: `=$A1`
```typescript
anchor = {
  rowMode: 'rel',   // —Å—Ç—Ä–æ–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è
  colMode: 'abs',   // —Å—Ç–æ–ª–±–µ—Ü –∞–±—Å–æ–ª—é—Ç–Ω—ã–π
  dRow: -1,
  dCol: 0
}
```
**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:** –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ —Å—Ç—Ä–æ–∫–∏ - –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è, –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ —Å—Ç–æ–ª–±—Ü–∞ - –∞–±—Å–æ–ª—é—Ç–Ω–∞—è.

---

## –ì—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞

#### –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Ñ–æ—Ä–º—É–ª—ã `=A1` –≤ B1:

```typescript
// 1. –ü–∞—Ä—Å–∏–º —Ñ–æ—Ä–º—É–ª—É
const formula = parseFormula("=A1", { r: 1, c: 2 });
// ‚Üí { t: 'Ref', ref: { base: {row:"id0",col:"id1"}, dRow:0, dCol:-1, ... }}

// 2. –ù–∞—Ö–æ–¥–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
const targetAddr = anchorToAddress(formula.ref);
// ‚Üí { row: "id0", col: "id0" }  (A1)

// 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ü–∏–∫–ª
if (deps.wouldCreateCycle(targetAddr, formulaAddr)) {
  // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å #CYCLE!
  return;
}

// 4. –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–±—Ä–æ
deps.addEdge(targetAddr, formulaAddr);
// A1 ‚Üí B1
```

#### –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ `=SUM(A1:A3)` –≤ A4:

```typescript
// 1. –ü–∞—Ä—Å–∏–º
const formula = parseFormula("=SUM(A1:A3)", { r: 4, c: 1 });

// 2. –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω
const cells = expandRange(formula.range);
// ‚Üí [A1, A2, A3]

// 3. –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –ö–ê–ñ–î–û–ô —è—á–µ–π–∫–∏
for (const cell of cells) {
  deps.addEdge(cell, formulaAddr);
}
// A1 ‚Üí A4
// A2 ‚Üí A4
// A3 ‚Üí A4

// 4. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
ranges.addWatch(formula.range, formulaAddr);
```

### –ü–µ—Ä–µ—Å—á–µ—Ç –ø–æ –≥—Ä–∞—Ñ—É

#### –ê–ª–≥–æ—Ä–∏—Ç–º:

```typescript
function recalc(changed: Set<Address>) {
  // 1. –ù–∞–π—Ç–∏ –≤—Å–µ—Ö –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö (BFS/DFS –ø–æ –≥—Ä–∞—Ñ—É)
  const affected = deps.affectedFrom(changed);
  // changed: {A1}
  // affected: {A1, B1, C1, D1, ...} - –≤—Å–µ —Ç—Ä–∞–Ω–∑–∏—Ç–∏–≤–Ω–æ –∑–∞–≤–∏—Å—è—â–∏–µ
  
  // 2. –¢–æ–ø–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
  const sorted = topologicalSort(affected);
  // [A1, B1, C1, D1] - —Å–Ω–∞—á–∞–ª–∞ —Ç–µ, –æ—Ç –∫–æ–≥–æ –∑–∞–≤–∏—Å—è—Ç –¥—Ä—É–≥–∏–µ
  
  // 3. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤ –ø–æ—Ä—è–¥–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  for (const key of sorted) {
    const cell = cells.get(key);
    if (cell.kind === 'formula') {
      cell.cached = evalFormula(cell.ast);
    }
  }
}
```

#### –ü—Ä–∏–º–µ—Ä:

```
–ì—Ä–∞—Ñ:
A1 ‚îÄ‚îÄ‚Üí B1 ‚îÄ‚îÄ‚Üí D1
 ‚îî‚îÄ‚îÄ‚îÄ‚Üí C1 ‚îÄ‚îÄ‚Üí D1

–ò–∑–º–µ–Ω–µ–Ω–∏–µ A1:
1. affected = {A1, B1, C1, D1}
2. sorted = [A1, B1, C1, D1]
3. –ü–µ—Ä–µ—Å—á–µ—Ç:
   - A1 (–∑–Ω–∞—á–µ–Ω–∏–µ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ)
   - B1 = eval(=A1) ‚Üí —á–∏—Ç–∞–µ–º A1
   - C1 = eval(=A1) ‚Üí —á–∏—Ç–∞–µ–º A1
   - D1 = eval(=SUM(B1:C1)) ‚Üí —á–∏—Ç–∞–µ–º B1, C1
```

### –î–µ—Ç–µ–∫—Ü–∏—è —Ü–∏–∫–ª–æ–≤

```typescript
function wouldCreateCycle(from: Address, to: Address): boolean {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –º–æ–∂–µ—Ç –ª–∏ TO –¥–æ—Å—Ç–∏—á—å FROM –ø–æ –≥—Ä–∞—Ñ—É?
  // –ï—Å–ª–∏ –¥–∞, —Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ FROM‚ÜíTO —Å–æ–∑–¥–∞—Å—Ç —Ü–∏–∫–ª
  
  const visited = new Set();
  const queue = [to];
  
  while (queue.length > 0) {
    const current = queue.shift();
    if (current === from) return true;  // –ù–∞—à–ª–∏ –ø—É—Ç—å TO‚ÜíFROM
    
    if (visited.has(current)) continue;
    visited.add(current);
    
    const dependents = deps.getDependents(current);
    queue.push(...dependents);
  }
  
  return false;  // –ü—É—Ç–∏ –Ω–µ—Ç
}
```

**–ü—Ä–∏–º–µ—Ä:**
```
A1: =B1
B1: =A1  ‚Üê –ø–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å

–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ B1:=A1:
wouldCreateCycle(A1, B1)
  –µ—Å—Ç—å –ª–∏ –ø—É—Ç—å B1 ‚Üí ... ‚Üí A1?
  B1 ‚Üí A1 (–¥–∞, –µ—Å—Ç—å –ø—Ä—è–º–æ–µ —Ä–µ–±—Ä–æ)
  ‚Üí true (—Ü–∏–∫–ª!)
  
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º B1: #CYCLE!
```

---

## –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### –í –ø–∞–º—è—Ç–∏

```
–õ–∏—Å—Ç 100√ó26, –∑–∞–ø–æ–ª–Ω–µ–Ω–æ 5 —è—á–µ–µ–∫:

CellStore:
{
  "id0:id0": { kind: "value", value: 10 },
  "id0:id1": { kind: "value", value: 20 },
  "id1:id0": { kind: "formula", ast: {...}, cached: 30 },
  "id1:id1": { kind: "formula", ast: {...}, cached: 50 },
  "id2:id0": { kind: "formula", ast: {...}, cached: 80 }
}

AxisIndex (rows):
{
  segments: [
    { startPos: 1, ids: ["id0", "id1", ..., "id99"] }
  ]
}

AxisIndex (cols):
{
  segments: [
    { startPos: 1, ids: ["id0", "id1", ..., "id25"] }
  ]
}

DepGraph:
{
  outgoing: {
    "id0:id0": Set["id1:id0"],        // A1 ‚Üí A2
    "id0:id1": Set["id1:id0"],        // B1 ‚Üí A2
    "id1:id0": Set["id1:id1"],        // A2 ‚Üí B2
    ...
  },
  incoming: { ... }
}

–ü–∞–º—è—Ç—å:
- CellStore: 5 —è—á–µ–µ–∫ √ó ~100 –±–∞–π—Ç = ~500 –±–∞–π—Ç
- AxisIndex: 126 ID √ó ~20 –±–∞–π—Ç = ~2.5 –ö–ë
- DepGraph: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —á–∏—Å–ª–∞ —Ä–µ–±–µ—Ä
–ò–¢–û–ì–û: ~3-5 –ö–ë (–≤–º–µ—Å—Ç–æ 2600 —è—á–µ–µ–∫ √ó 100 –±–∞–π—Ç = 260 –ö–ë)
```

### –†–∞–∑—Ä–µ–∂–µ–Ω–Ω–æ—Å—Ç—å

```
–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è = 5 / (100 √ó 26) = 0.19%

–ü–∞–º—è—Ç—å —Ä–∞—Å—Ç–µ—Ç –æ—Ç –ó–ê–ü–û–õ–ù–ï–ù–ù–´–•, –∞ –Ω–µ –æ—Ç –†–ê–ó–ú–ï–†–ê!
```

---

## –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –æ–ø–µ—Ä–∞—Ü–∏–π

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è: `table.setValue({r:1, c:1}, 10)`

```typescript
// 1. –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –≤ –∞–¥—Ä–µ—Å
const addr = sheet.posToAddr({ r: 1, c: 1 });
// ‚Üí { row: "id0", col: "id0" }

// 2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –±—ã–ª–∞ —Ñ–æ—Ä–º—É–ª–∞)
if (oldCell?.kind === 'formula') {
  deps.removeAll(addr);
  ranges.removeWatches(addr);
}

// 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
cells.set(addr, { kind: 'value', value: 10 });

// 4. –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∑–∞–≤–∏—Å–∏–º—ã–µ
const dirty = new Set([addressKey(addr)]);
recalc(dirty);
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ—Ä–º—É–ª—ã: `table.setFormula({r:2, c:1}, "=A1")`

```typescript
// 1. –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é
const addr = sheet.posToAddr({ r: 2, c: 1 });

// 2. –ü–∞—Ä—Å–∏—Ç—å —Ñ–æ—Ä–º—É–ª—É
const formula = parseFormula("=A1", { r: 2, c: 1 });
// ‚Üí { t: 'Ref', ref: { base: addr, dRow: -1, ... } }

// 3. –°–æ–±—Ä–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
const deps = collectDependencies(formula);
// ‚Üí [{ row: "id0", col: "id0" }]  (A1)

// 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–∏–∫–ª—ã
for (const dep of deps) {
  if (wouldCreateCycle(dep, addr)) {
    cells.set(addr, { kind: 'formula', ast: formula, cached: '#CYCLE!' });
    return;
  }
}

// 5. –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
for (const dep of deps) {
  deps.addEdge(dep, addr);
}

// 6. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º—É–ª—É
cells.set(addr, { kind: 'formula', ast: formula });

// 7. –í—ã—á–∏—Å–ª–∏—Ç—å
const dirty = new Set([addressKey(addr)]);
recalc(dirty);
```

### 3. –í—Å—Ç–∞–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏: `table.insertRows(2, 1)`

```typescript
// –ö–†–ò–¢–ò–ß–ù–û: –ø–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π!

// 1. –°–ù–ê–ß–ê–õ–ê —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É–ª—ã (–î–û –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤!)
for (const [key, cell] of cells.entries()) {
  if (cell.kind !== 'formula') continue;
  
  const newAst = transformFormula(
    cell.ast,
    { axis: 'row', atPos: 2, ins: 1, del: 0 }
  );
  
  cells.set(addr, { ...cell, ast: newAst });
}

// 2. –ü–û–¢–û–ú –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã
rows.insert(2, 1);  // –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π ID: "id100"

// –¢–µ–ø–µ—Ä—å:
// –ü–æ–∑–∏—Ü–∏—è 1 ‚Üí id0
// –ü–æ–∑–∏—Ü–∏—è 2 ‚Üí id100 (–Ω–æ–≤–∞—è!)
// –ü–æ–∑–∏—Ü–∏—è 3 ‚Üí id1 (–±—ã–ª–∞ –ø–æ–∑–∏—Ü–∏—è 2)

// 3. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ
const dirty = ... // —Ñ–æ—Ä–º—É–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª–∏—Å—å
recalc(dirty);
```

**–ü–æ—á–µ–º—É –ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω:**
- `transformAnchor` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `idToPos()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –ø–æ–∑–∏—Ü–∏–π
- –ï—Å–ª–∏ —Å–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã, `idToPos()` –≤–µ—Ä–Ω–µ—Ç –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏
- –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –¥–≤–∞–∂–¥—ã (–¥–≤–æ–π–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ)!

### 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è: `table.getValue({r:1, c:1})`

```typescript
// 1. –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –≤ –∞–¥—Ä–µ—Å
const addr = sheet.posToAddr({ r: 1, c: 1 });

// 2. –ü–æ–ª—É—á–∏—Ç—å —è—á–µ–π–∫—É
const cell = cells.get(addr);

// 3. –í–µ—Ä–Ω—É—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
if (cell.kind === 'value') {
  return cell.value;
} else {
  return cell.cached;  // –ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ–æ—Ä–º—É–ª—ã
}
```

---

## –ê–ª–≥–æ—Ä–∏—Ç–º—ã –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å

### –î–æ—Å—Ç—É–ø –∫ —è—á–µ–π–∫–µ

```typescript
getValue(pos: Position): Scalar
```

**–°–ª–æ–∂–Ω–æ—Å—Ç—å:**
1. `posToAddr(pos)`: O(log S) –≥–¥–µ S - —á–∏—Å–ª–æ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
   - –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ S=1, –ø–æ—ç—Ç–æ–º—É O(1)
2. `cells.get(addr)`: O(1) - Map lookup

**–ò—Ç–æ–≥–æ: O(1)** –≤ —Ç–∏–ø–∏—á–Ω–æ–º —Å–ª—É—á–∞–µ

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è

```typescript
setValue(pos: Position, value: number): void
```

**–°–ª–æ–∂–Ω–æ—Å—Ç—å:**
1. `posToAddr(pos)`: O(1)
2. `cells.set(addr, cell)`: O(1)
3. `recalc(dirty)`: O(|affected| + |edges|)
   - –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —á–∏—Å–ª—É —Ñ–æ—Ä–º—É–ª, –∑–∞–≤–∏—Å—è—â–∏—Ö –æ—Ç —ç—Ç–æ–π —è—á–µ–π–∫–∏

**–ò—Ç–æ–≥–æ: O(1 + affected formulas)**

### –í—Å—Ç–∞–≤–∫–∞ —Å—Ç—Ä–æ–∫/—Å—Ç–æ–ª–±—Ü–æ–≤

```typescript
insertRows(atPos: number, count: number): void
```

**–°–ª–æ–∂–Ω–æ—Å—Ç—å:**
1. –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è —Ñ–æ—Ä–º—É–ª: O(F) –≥–¥–µ F - —á–∏—Å–ª–æ —Ñ–æ—Ä–º—É–ª
   - –ö–∞–∂–¥–∞—è —Ñ–æ—Ä–º—É–ª–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
   - O(1) –Ω–∞ —Ñ–æ—Ä–º—É–ª—É
2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞: O(log S + N) –≥–¥–µ N - —á–∏—Å–ª–æ ID –≤ —Å–µ–≥–º–µ–Ω—Ç–µ
   - –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ S=1, N=100, –ø–æ—ç—Ç–æ–º—É O(100)
3. –ü–µ—Ä–µ—Å—á–µ—Ç: O(|affected| + |edges|)

**–ò—Ç–æ–≥–æ: O(F + affected formulas)**

**–í–∞–∂–Ω–æ:** –ù–ï O(total cells)! –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º—É–ª—ã, –Ω–µ –≤—Å–µ —è—á–µ–π–∫–∏.

### –ü–µ—Ä–µ—Å—á–µ—Ç —Ñ–æ—Ä–º—É–ª

```typescript
recalc(dirty: Set<Address>): void
```

**–°–ª–æ–∂–Ω–æ—Å—Ç—å:**
1. `affectedFrom(dirty)`: O(V + E) BFS/DFS –ø–æ –≥—Ä–∞—Ñ—É
   - V = —á–∏—Å–ª–æ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö —É–∑–ª–æ–≤
   - E = —á–∏—Å–ª–æ —Ä–µ–±–µ—Ä –º–µ–∂–¥—É –Ω–∏–º–∏
2. `topologicalSort(affected)`: O(V + E)
3. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π —Ñ–æ—Ä–º—É–ª—ã:
   - Ref: O(1)
   - Sum: O(R) –≥–¥–µ R - —á–∏—Å–ª–æ —è—á–µ–µ–∫ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
     - –ù–æ —Ç–æ–ª—å–∫–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö! –ü—É—Å—Ç—ã–µ –Ω–µ –∏—Ç–µ—Ä–∏—Ä—É—é—Ç—Å—è

**–ò—Ç–æ–≥–æ: O(V + E + Œ£R)** –≥–¥–µ Œ£R - —Å—É–º–º–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤

### –ü–∞–º—è—Ç—å

```
–ü—É—Å—Ç–∞—è —Ç–∞–±–ª–∏—Ü–∞ 1M √ó 16K:
- CellStore: 0 (–Ω–µ—Ç —è—á–µ–µ–∫)
- AxisIndex (rows): 1M ID √ó 20 –±–∞–π—Ç = 20 –ú–ë
- AxisIndex (cols): 16K ID √ó 20 –±–∞–π—Ç = 320 –ö–ë
–ò–¢–û–ì–û: ~20 –ú–ë

–ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –Ω–∞ 1% —Ç–∞–±–ª–∏—Ü–∞:
- CellStore: 160K —è—á–µ–µ–∫ √ó 100 –±–∞–π—Ç = 16 –ú–ë
- AxisIndex: 20 –ú–ë (–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)
- DepGraph: ~–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ñ–æ—Ä–º—É–ª, ~5-10 –ú–ë
–ò–¢–û–ì–û: ~40-50 –ú–ë

–†–æ—Å—Ç –ø–∞–º—è—Ç–∏ = O(filled cells + formulas)
```

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –¢–µ–∫—É—â–∏–µ

1. **–†–∞–∑—Ä–µ–∂–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ** - Map –≤–º–µ—Å—Ç–æ –º–∞—Å—Å–∏–≤–∞
2. **–°—Ç–∞–±–∏–ª—å–Ω—ã–µ ID** - –≤—Å—Ç–∞–≤–∫–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
3. **–Ø–∫–æ—Ä—è** - –ª–µ–Ω–∏–≤–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫
4. **–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç** - —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ
5. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–æ—Ä–º—É–ª —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

### –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–û–±—Ä–∞—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å ID‚ÜíPos**
   - –°–µ–π—á–∞—Å: O(N) –≥–¥–µ N - —á–∏—Å–ª–æ ID –≤ —Å–µ–≥–º–µ–Ω—Ç–µ
   - –° –∏–Ω–¥–µ–∫—Å–æ–º: O(1)
   - –ö–æ–º–ø—Ä–æ–º–∏—Å—Å: –ø–∞–º—è—Ç—å vs —Å–∫–æ—Ä–æ—Å—Ç—å

2. **B-–¥–µ—Ä–µ–≤–æ –¥–ª—è AxisIndex**
   - –°–µ–π—á–∞—Å: –ª–∏–Ω–µ–π–Ω—ã–π –º–∞—Å—Å–∏–≤ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
   - –° B-–¥–µ—Ä–µ–≤–æ–º: O(log N) –¥–ª—è –±–æ–ª—å—à–∏—Ö –ª–∏—Å—Ç–æ–≤
   - –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ –±–æ–ª—å—à–∏—Ö –ª–∏—Å—Ç–æ–≤

3. **Dirty regions –≤–º–µ—Å—Ç–æ dirty cells**
   - –°–µ–π—á–∞—Å: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∫–∞–∂–¥—É—é —è—á–µ–π–∫—É
   - –° —Ä–µ–≥–∏–æ–Ω–∞–º–∏: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã
   - –ü–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

4. **–í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è UI**
   - –°–µ–π—á–∞—Å: —Ä–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ –≤–∏–¥–∏–º—ã–µ —è—á–µ–π–∫–∏
   - –° –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–µ–π: —Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
   - –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü

5. **Web Workers –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞**
   - –°–µ–π—á–∞—Å: —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç
   - –° Workers: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç
   - –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ concern**: –ø–æ–∑–∏—Ü–∏–∏ ‚â† –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
2. **Immutability ID**: ID –Ω–µ –º–µ–Ω—è—é—Ç—Å—è, –º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –º–∞–ø–ø–∏–Ω–≥–∏
3. **Lazy evaluation**: —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è —è–∫–æ—Ä–µ–π "–Ω–∞ –ª–µ—Ç—É"
4. **Incremental computation**: –ø–µ—Ä–µ—Å—á–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö
5. **Sparse is fast**: –ø–∞–º—è—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–π

‚úÖ **O(filled)** –ø–∞–º—è—Ç—å, –∞ –Ω–µ O(rows √ó cols)  
‚úÖ **O(log S)** –¥–æ—Å—Ç—É–ø –∫ —è—á–µ–π–∫–µ, –≥–¥–µ S –æ–±—ã—á–Ω–æ 1  
‚úÖ **O(affected)** –ø–µ—Ä–µ—Å—á–µ—Ç, –∞ –Ω–µ O(all formulas)  
‚úÖ **O(formulas)** —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ, –∞ –Ω–µ O(all cells)  

### –ß—Ç–æ –º–æ–∂–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –¥–∞–ª—å—à–µ

üìà –ë–æ–ª—å—à–µ —Ç–∏–ø–æ–≤ —Ñ–æ—Ä–º—É–ª (IF, VLOOKUP, ...)  
üìà –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç—Ä–æ–∫, –¥–∞—Ç, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è  
üìà –ú—É–ª—å—Ç–∏-–ª–∏—Å—Ç—ã —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ –º–µ–∂–¥—É –ª–∏—Å—Ç–∞–º–∏  
üìà Undo/Redo —á–µ—Ä–µ–∑ command pattern  
üìà Persistence —á–µ—Ä–µ–∑ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é  

---

**–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç: –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –≤–∞–∂–Ω–µ–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏!**

–°–∏—Å—Ç–µ–º–∞ —è–∫–æ—Ä–µ–π –ø–æ–∑–≤–æ–ª–∏–ª–∞ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –≤—Å–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö/–∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –±–µ–∑ –µ–¥–∏–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ ID –∏ –ø–æ–∑–∏—Ü–∏–π —Å–¥–µ–ª–∞–ª–æ –≤—Å—Ç–∞–≤–∫–∏/—É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã–º–∏. –ì—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ–±–µ—Å–ø–µ—á–∏–ª –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

**–°–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–µ –≤ –∫–æ–¥–µ, –∞ –≤ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö.**

