# История изменений

## Исправление логики трансформации (последний коммит)

### Проблема
При вставке/удалении строк и столбцов происходило **двойное смещение** формул:
- Формула `D2: =SUM(A2:C2) = 6` при вставке столбца после B превращалась в `E2: =SUM(C2:E2) = 9`
- Диапазон неправильно изменялся (начало сдвигалось, конец дублировал смещение)

### Причины
1. **Неправильный порядок операций**: индексы обновлялись ДО трансформации якорей
2. **Двойное применение splice**: в `transformRange` сплайс применялся дважды - в `transformAnchor` и затем еще раз добавлением `splice.ins`
3. **Сложная логика** в `transformAnchor` с множественными условиями

### Решение

#### 1. Изменен порядок в `applySplice` (sheet.ts)
```typescript
// БЫЛО: сначала обновляли индексы, потом трансформировали якоря
// СТАЛО: сначала трансформируем якоря, потом обновляем индексы
```

Это критично, потому что трансформация использует `idToPos()`, которая после обновления индексов возвращает уже новые позиции.

#### 2. Упрощена логика `transformAnchor` (transform.ts)
- Убрана сложная логика с множественными проверками
- Введена единая функция `applySpliceToPos(pos)` для применения сплайса к позиции
- **Относительные ссылки**: цель сдвигается вместе с ячейкой → `newTargetPos = applySpliceToPos(targetPos)`
- **Абсолютные ссылки**: цель остается на той же позиции → `newTargetPos = targetPos`

#### 3. Упрощена логика `transformRange` (transform.ts)
- Убрана попытка вручную "расширять" диапазон
- Просто трансформируем оба якоря через `transformAnchor`
- Для относительных ссылок они автоматически "прилипают" к ячейкам, обеспечивая расширение диапазона

### Результат

Теперь при вставке столбца после B в примере выше:

**ДО вставки:**
```
A2: 1
B2: 2
C2: 3
D2: =SUM(A2:C2) = 6
```

**ПОСЛЕ вставки:**
```
A2: 1
B2: 2
C2: (пустой новый столбец)
D2: 3 (бывший C2, сдвинулся)
E2: =SUM(A2:D2) = 6 ✅ (формула сдвинулась, диапазон расширился)
```

### Протестировано
- ✅ Вставка столбцов/строк
- ✅ Удаление столбцов/строк
- ✅ Относительные ссылки (`=A1`)
- ✅ Абсолютные ссылки (`=$A$1`)
- ✅ Смешанные ссылки (`=A$1`, `=$A1`)
- ✅ Диапазоны SUM (`=SUM(A1:C3)`)
- ✅ Расширение диапазонов при вставке внутрь
- ✅ Сохранение значений

